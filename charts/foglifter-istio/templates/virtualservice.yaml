kind: VirtualService
apiVersion: networking.istio.io/v1beta1
metadata:
  name: {{ .Release.Name }}
  labels:
    app: {{ .Release.Name }}
spec:
  hosts:
    {{- default (list "*") .Values.hosts | toYaml | nindent 4 }}
  gateways:
    - {{ .Release.Name }}
  http:
    {{- if (ne (.Values.argocd).enabled false) }}
    {{- if not (.Values.argocd).fqdn }}{{- fail "Please set the argocd.fqdn value." }}{{- end }}
    - match:
        - uri:
            prefix: {{ default "/argo-cd" (.Values.argocd).prefix }}
      route:
        - destination:
            host: {{ (.Values.argocd).fqdn }}
            port:
              number: {{ default "80" (.Values.argocd).port | int }}
    {{- end }}
    {{- if not (.Values.apiservice).fqdn }}{{- fail "Please set the apiservice.fqdn value." }}{{- end }}
    - match:
        - uri:
            prefix: {{ default "/api/auth" (.Values.apiservice).prefix }}
      route:
        - destination:
            host: {{ (.Values.apiservice).fqdn }}
            port:
              number: {{ default "8080" (.Values.apiservice).port | int }}
    {{- if not (.Values.core).fqdn }}{{- fail "Please set the core.fqdn value." }}{{- end }}
    - route:
        - destination:
            host: {{ (.Values.core).fqdn }}
            port:
              number: {{ default "8080" (.Values.core).port | int }}
    {{- if not (.Values.module).fqdn }}{{- fail "Please set the module.fqdn value." }}{{- end }}
    - match:
        - uri:
            prefix: {{ default "/api/module" (.Values.module).prefix }}
      route:
        - destination:
            host: {{ (.Values.module).fqdn }}
            port:
              number: {{ default "8080" (.Values.module).port | int }}
    {{- if (ne (.Values.view).enabled false) }}
    {{- if not (.Values.view).fqdn }}{{- fail "Please set the view.fqdn value." }}{{- end }}
    - match:
        - uri:
            prefix: {{ default "/dashboard" (.Values.view).prefix }}
      route:
        - destination:
            host: {{ (.Values.view).fqdn }}
            port:
              number: {{ default "3000" (.Values.view).port | int }}
    {{- end }}
  {{- if (ne (.Values.mongo).enabled false) }}
  {{- if not (.Values.mongo).fqdn }}{{- fail "Please set the mongo.fqdn value." }}{{- end }}
  tcp:
    - match:
        - port: {{ default "27017" (.Values.mongo).port | int }}
      route:
        - destination:
            host: {{ (.Values.mongo).fqdn }}
            port:
              number: {{ default "27017" (.Values.mongo).port | int }}
  {{- end }}
