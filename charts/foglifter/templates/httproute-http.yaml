{{- if and (.Values.gatewayAPI).enabled ((.Values.gatewayAPI).httpRoute).enabled }}
{{- if (((.Values.gatewayAPI.gateway).listeners).http).enabled }}
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: {{ .Values.gatewayAPI.httpRoute.name }}-http
  namespace: {{ default .Release.Namespace .Values.gatewayAPI.httpRoute.namespace }}
  {{- with .Values.gatewayAPI.httpRoute.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  labels:
    app: {{ .Release.Name }}
spec:
  parentRefs:
    - name: {{ .Values.gatewayAPI.gateway.name }}
      sectionName: http
      namespace: {{ default .Release.Namespace .Values.gatewayAPI.gateway.namespace }}
  {{- $routes := .Values.gatewayAPI.httpRoute.routes }}
  {{- $releaseName := .Release.Name }}
  {{- if or .Values.domain .Values.gatewayAPI.httpRoute.hostnames }}
  hostnames:
    {{- if .Values.domain }}
    - {{ .Values.domain }}
    {{- end }}
    {{- with .Values.gatewayAPI.httpRoute.hostnames }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
  {{- end }}
  {{- $httpsEnabled := (.Values.gatewayAPI.gateway.listeners.https).enabled }}
  {{- $httpsRedirect := .Values.gatewayAPI.httpRoute.httpsRedirect }}
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: {{ $routes.apiservice.path }}
      {{- if and $httpsEnabled $httpsRedirect }}
      filters:
        - type: RequestRedirect
          requestRedirect:
            scheme: https
            statusCode: 301
      {{- else }}
      backendRefs:
        - name: {{ $releaseName }}-apiservice-svc
          port: {{ $.Values.apiservice.port | int }}
      {{- end }}
    - matches:
        - path:
            type: PathPrefix
            value: {{ $routes.auth.path }}
      {{- if and $httpsEnabled $httpsRedirect }}
      filters:
        - type: RequestRedirect
          requestRedirect:
            scheme: https
            statusCode: 301
      {{- else }}
      backendRefs:
        - name: {{ $releaseName }}-auth-svc
          port: {{ $.Values.auth.port | int }}
      {{- end }}
  {{- if and $routes.client.enabled (.Values.client).enabled }}
    - matches:
        - path:
            type: PathPrefix
            value: {{ $routes.client.path }}
      {{- if and $httpsEnabled $httpsRedirect }}
      filters:
        - type: RequestRedirect
          requestRedirect:
            scheme: https
            statusCode: 301
      {{- else }}
      backendRefs:
        - name: {{ $releaseName }}-client-svc
          port: {{ $.Values.client.port | int }}
      {{- end }}
  {{- end }}
  {{- if and $routes.compliance.enabled (.Values.compliance).enabled }}
    - matches:
        - path:
            type: PathPrefix
            value: {{ $routes.compliance.path }}
      {{- if and $httpsEnabled $httpsRedirect }}
      filters:
        - type: RequestRedirect
          requestRedirect:
            scheme: https
            statusCode: 301
      {{- else }}
      backendRefs:
        - name: {{ $releaseName }}-compliance-svc
          port: {{ $.Values.compliance.port | int }}
      {{- end }}
  {{- end }}
    - matches:
        - path:
            type: PathPrefix
            value: {{ $routes.core.path }}
      {{- if and $httpsEnabled $httpsRedirect }}
      filters:
        - type: RequestRedirect
          requestRedirect:
            scheme: https
            statusCode: 301
      {{- else }}
      backendRefs:
        - name: {{ $releaseName }}-core-svc
          port: {{ $.Values.core.port | int }}
      {{- end }}
  {{- if and $routes.routing.enabled (.Values.routing).enabled }}
    - matches:
        - path:
            type: PathPrefix
            value: {{ $routes.routing.path }}
      {{- if and $httpsEnabled $httpsRedirect }}
      filters:
        - type: RequestRedirect
          requestRedirect:
            scheme: https
            statusCode: 301
      {{- else }}
      backendRefs:
        - name: {{ $releaseName }}-routing-svc
          port: {{ $.Values.routing.port | int }}
      {{- end }}
  {{- end }}
  {{- if and $routes.scheduler.enabled (.Values.scheduler).enabled }}
    - matches:
        - path:
            type: PathPrefix
            value: {{ $routes.scheduler.path }}
      {{- if and $httpsEnabled $httpsRedirect }}
      filters:
        - type: RequestRedirect
          requestRedirect:
            scheme: https
            statusCode: 301
      {{- else }}
      backendRefs:
        - name: {{ $releaseName }}-scheduler-svc
          port: {{ $.Values.scheduler.port | int }}
      {{- end }}
  {{- end }}
{{- end }}
{{- end }}
